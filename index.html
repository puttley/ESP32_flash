<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-S3 Web Flasher</title>
</head>
<body>
    <h1>ESP32-S3 Web Flasher 3</h1>
    <button id="connectBtn">Connect to ESP32-S3</button>
    <input type="file" id="fileInput" accept=".bin" style="display:none;" />
    <button id="flashBtn" disabled>Flash Binary</button>
    <progress id="progressBar" value="0" max="100" style="display:none;"></progress>
    <p id="status"></p>

    <script type="module">
        import { ESPLoader } from 'https://cdn.jsdelivr.net/gh/adafruit/Adafruit_WebSerial_ESPTool@1.2.0/dist/web/index.js';

        let port, espTool;
        let connected = false;

        const connectBtn = document.getElementById("connectBtn");
        const fileInput = document.getElementById("fileInput");
        const flashBtn = document.getElementById("flashBtn");
        const progressBar = document.getElementById("progressBar");
        const status = document.getElementById("status");

        // Update UI based on connection status
        function updateUI() {
            fileInput.style.display = connected ? "block" : "none";
            flashBtn.disabled = !connected || !fileInput.files.length;
            connectBtn.textContent = connected ? "Disconnect" : "Connect to ESP32-S3";
        }

        // Connect to ESP32-S3
        connectBtn.addEventListener("click", async () => {
            if (!connected) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 }); // Lowered baud rate for improved stability

                    // Pass the console as the logger for ESPLoader
                    espTool = new ESPLoader(port, console);

                    await espTool.initialize();
                    connected = true;
                    status.textContent = "Connected to ESP32-S3";
                } catch (err) {
                    status.textContent = `Connection failed: ${err.message}`;
                    console.error("Connection failed:", err); // Additional logging to help debug
                }
            } else {
                await port.close();
                connected = false;
                status.textContent = "Disconnected";
            }
            updateUI();
        });

        // Enable flash button if a file is selected
        fileInput.addEventListener("change", () => {
            flashBtn.disabled = !connected || !fileInput.files.length;
        });

        // Flash the binary file to ESP32-S3
        flashBtn.addEventListener("click", async () => {
            if (!fileInput.files.length) {
                alert("Please select a binary file to upload.");
                return;
            }

            const file = fileInput.files[0];
            const fileBuffer = await file.arrayBuffer();
            const fileArray = new Uint8Array(fileBuffer);

            progressBar.style.display = "block";
            progressBar.value = 0;
            status.textContent = "Starting upload...";

            try {
                // Configure block size and erase size to match Adafruit's WebSerial tool
                await espTool.flashData(
                    fileArray,
                    0x000, // Start address for the ESP32-S3
                    {
                        eraseSize: 0x400000, // 4MB flash size
                        blockSize: 0x4000, // Block size set to 0x4000
                        onProgress: (bytesWritten, totalBytes) => {
                            const progress = (bytesWritten / totalBytes) * 100;
                            progressBar.value = progress;
                            status.textContent = `Uploading... ${Math.floor(progress)}%`;
                        }
                    }
                );
                status.textContent = "Upload complete!";
            } catch (err) {
                status.textContent = `Upload failed: ${err.message}`;
            } finally {
                progressBar.style.display = "none";
            }
        });
    </script>
</body>
</html>
